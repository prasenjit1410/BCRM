/**
 * [...]
 * Purpose :callout from SF to SertifiAPI to avoid manual filling of CC auth documents in sertifi for MS Team
 * @author  :Keerthi Gaddam
 * @version 1
 * @LastModifiedDate :7/28/2022
 * @Dependent classes: SertifiRequestBody
 *
 */

public with sharing class SertifiCallOuts {
   
    public static void getAccessToken( String contractId ){
        
        List<Contract__c> ContractList = [ select Id,Vpay_Card_Number__c,
                                          Vpay_Expiration__c,
                                          Allow_Incidentals__c,
                                          supplier__c,guest_name__c,
                                          property_confirmation_number__c,check_in__c, Property__r.Sertifi_Property_ID__c 
                                          from Contract__c
                                          where Id = : contractid ];
        Contract__c ctrobj = ContractList[0];
        
        CalloutSettingsInfo__mdt callsett = CalloutSettingsInfo__mdt.getInstance( 'Sertifi' ) ;

        // call to get new access token
        
        HttpRequest request = new HttpRequest();
        request.setMethod( callsett.Method_Type__c );
        request.setEndpoint( callsett.Token_Endpoint__c);
        
        String reqbodyfortoken ;
        reqbodyfortoken = 'grant_type=' + callsett.grant_type__c ; 
        reqbodyfortoken +=  '&client_id=' + callsett.client_id__c ;
        reqbodyfortoken += '&scope=' + callsett.scope__c;
        reqbodyfortoken += '&client_secret=' + callsett.client_secret__c ;
        
        request.setBody(reqbodyfortoken);
        request.setHeader( 'Content-Type', callsett.Token_Content_Type__c) ;
        
        
        request.setTimeout(2000);
        
        Http http = new Http();
        HTTPResponse resp = http.send(request);
        System.debug( 'response of token is ' + resp.getStatusCode() + ' value is '  + resp.getBody() );
        
        responseToken respToken = (responseToken)JSON.deserialize(resp.getBody(), responseToken.class) ;
        
       
        getResponseBody( ctrobj, respToken.access_token , callsett );
        
    }
    
    public static void getResponseBody( Contract__c ctrobj, String accessToken, CalloutSettingsInfo__mdt callsett ){
        String endpoint = callsett.Resource_Endpoint__c + '/' + ctrobj.Property__r.Sertifi_Property_ID__c ;
        // Final call with access token to get actual response
        Http finalhttp = new Http();
        HttpRequest finalrequest = new HttpRequest();
        
        finalrequest.setMethod( callsett.Method_Type__c );
        finalrequest.setEndpoint(  endpoint ) ;
        finalrequest.setHeader('Authorization', 'Bearer ' + accessToken );
        
        if( ctrobj != null ){           
            
            RequestBodyJSON rbj = new RequestBodyJSON();
            rbj.reqbody = rbj.prepareReqBody(ctrobj);
            
            System.debug(  'rbj.reqbody is '  + rbj.reqbody );
            finalrequest.setBody(rbj.reqbody ) ;
            finalrequest.setHeader( 'Content-Type',callsett.Resource_Content_Type__c ) ;
            finalrequest.setHeader( 'Content-Length', '597' ) ;
            
            HTTPResponse finalresp = finalhttp.send(finalrequest);
            System.debug( 'final response of token is ' + finalresp.getStatusCode() + ' value is '  + finalresp.getBody() );
            
        }
        
    }
    
    public class ResponseToken{
        public String access_token;
    }
    
    
    public class RequestBodyJSON{
        public String reqbody;       
        
                          
        public String prepareReqBody( Contract__c ctrobj){

            String expDate = ctrobj.Vpay_Expiration__c ;
            
            Date checkInDate = ctrobj.check_in__c ;
            
            String[] expDates = expDate.split( '/' );
            
            DateTime expDateTime = DateTime.newInstance(  Integer.valueOf(expDates[1]), Integer.valueOf(expDates[0]), 25, 00, 00, 00)  ;
            
            Datetime arrivalDatetime = DateTime.newInstance(  checkInDate.year(), checkInDate.month(), checkInDate.day(), 00, 00, 00)  ;
            
            SertifiRequestBody srfrb = new SertifiRequestBody();
            
            // Card
            SertifiRequestBody.CardDetail  srtcard = new SertifiRequestBody.CardDetail();            
            srtcard.CardHolderName = 'Hotel Engine' ;
            srtcard.CardNumber = ctrobj.Vpay_Card_Number__c ;
            srtcard.CardType = ctrobj.Vpay_Card_Number__c.startsWith('4') ? 'Visa' : 'Mastercard' ;
            srtcard.ExpirationDate = expDateTime ; //DateTime.newInstance( 2024, 08, 24, 00, 00, 00)  ;
            // assign card
            srfrb.Card = srtcard ;
            
            // Contact
            SertifiRequestBody.CompanyDetail  companyd = new SertifiRequestBody.CompanyDetail();
            companyd.Address = '950 S Cherry Street' ;
            companyd.Name =  'Hotel Engine' ;  
            srfrb.Company = companyd ;
            
            
            // Contact
            SertifiRequestBody.ContactDetail  contactd = new SertifiRequestBody.ContactDetail();
            
            contactd.PhoneNumber = '(855) 567-4683';
            contactd.EmailAddress = 'support@hotelengine.com';  
            contactd.InvoiceEmailAddress = 'support@hotelengine.com';
            contactd.SupportEmailAddress = '';  
            contactd.SupportPhoneNumber = '';
            
            srfrb.Contact = contactd ;
            
            
            // Traveler
            SertifiRequestBody.TravelerDetail  travelD = new SertifiRequestBody.TravelerDetail();
            travelD.FirstName = ctrobj.guest_name__c;
            travelD.LastName = ctrobj.guest_name__c;
            srfrb.Traveler = travelD ;
            
            // PaymentInstructions
            srfrb.PaymentInstructions = (ctrobj.Allow_Incidentals__c == true && ctrobj.supplier__c == 'SabreCSL' ) ? 	'Room, tax, and incidentals' : ( ctrobj.Allow_Incidentals__c == true ?  'Incidentals' : 'Room and tax only' )	;
                
            // ReferenceNumber
            srfrb.ReferenceNumber = ctrobj.property_confirmation_number__c;
            
            // ArrivalDate 
            srfrb.ArrivalDate =  arrivalDatetime  ;

            return JSON.serialize( srfrb ) ;
        }
        
    }
    
    
}
